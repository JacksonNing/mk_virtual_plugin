<section id="nice" data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="font-size: 16px; color: black; padding: 0 10px; line-height: 1.6; word-spacing: 0px; letter-spacing: 0px; word-break: break-word; word-wrap: break-word; text-align: left; font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, 'PingFang SC', Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;"><h3 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 20px;"><span class="prefix" style="display: none;"></span><span class="content">前言</span><span class="suffix" style="display: none;"></span></h3>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;">插件化技术从 2015 年就开始百花齐放,如: 奇虎 360 的 replugin,滴滴的 VirtualAPK,到现在的 VirtualApp,插件化经历了市场严峻的考验,也算逐步成熟,今天就带大家手把手实现一个插件化Activity框架,希望对你有所帮助~</p>
<h3 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 20px;"><span class="prefix" style="display: none;"></span><span class="content">插件化概念</span><span class="suffix" style="display: none;"></span></h3>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;">插件化是一种动态加载四大组件的技术。最早是为了解决 65535 限制的问题,后来 Google 出来了 multidex 来专门解决<br><br>现在市面使用插件化一定程度上可以减少安装包大小,实现项目组件化,将项目拆分方便隔离,降低组件化耦合度太高的问题<br><br>当然插件化也能 实现 bug 热修复,由于虚拟机的存在，Java 本身是支持动态加载任意类的。只是安卓系统在四大组件上做了限制，当你尝试打开不在清单中的组件时，给你一个崩溃。<br><br>所谓插件化，本质上是为了绕过这个限制，使得应用可以自由地打开和使用四大组件。</p>
<h3 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 20px;"><span class="prefix" style="display: none;"></span><span class="content">插件化业务价值</span><span class="suffix" style="display: none;"></span></h3>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;">插件化无非是为了解决类加载和资源加载的问题,资源加载一般是通过反射 AssertManager , 按照类加载划分,插件化一般分为静态代理和 Hook 的方式,使用插件化一般为了解决应用新版本覆盖慢的问题。<br><br>四大组件可动态加载，意味着用户不需要手动安装新版本的应用，我们也可以给用户提供新的功能和页面，或者在用户无感的情况下修复 bug。</p>
<h3 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 20px;"><span class="prefix" style="display: none;"></span><span class="content">插件化项目结构</span><span class="suffix" style="display: none;"></span></h3>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;"><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b59dc759ffe744ec8e865df9f6868f5f~tplv-k3u1fbpfcp-watermark.image" alt style="display: block; margin: 0 auto; max-width: 100%; border-radius: 10px; border: 3px solid #F7D3CC;"></figure>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;"><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f3361083e7664f739eb6a54cac16c888~tplv-k3u1fbpfcp-watermark.image" alt style="display: block; margin: 0 auto; max-width: 100%; border-radius: 10px; border: 3px solid #F7D3CC;"></figure>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;"><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6d2b7c3671144487ba6475215211ddea~tplv-k3u1fbpfcp-watermark.image" alt style="display: block; margin: 0 auto; max-width: 100%; border-radius: 10px; border: 3px solid #F7D3CC;"></figure>
<h3 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 20px;"><span class="prefix" style="display: none;"></span><span class="content">插件化开发流程</span><span class="suffix" style="display: none;"></span></h3>
<h4 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 18px;"><span class="prefix" style="display: none;"></span><span class="content">第一步: 创建 app 主工程作为宿主工程</span><span class="suffix" style="display: none;"></span></h4>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;"><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7349582cf65e41ba84c40e7a9b22c472~tplv-k3u1fbpfcp-watermark.image" alt style="display: block; margin: 0 auto; max-width: 100%; border-radius: 10px; border: 3px solid #F7D3CC;"></figure>
<h4 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 18px;"><span class="prefix" style="display: none;"></span><span class="content">第二步: 创建 plugin_package 作为插件工程,负责打插件包</span><span class="suffix" style="display: none;"></span></h4>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;"><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4855a85cb6384bb0a0050abe56e49f74~tplv-k3u1fbpfcp-watermark.image" alt style="display: block; margin: 0 auto; max-width: 100%; border-radius: 10px; border: 3px solid #F7D3CC;"></figure>
<h4 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 18px;"><span class="prefix" style="display: none;"></span><span class="content">第三步: 创建接口工程 lifecycle_mananager ,负责管理四大组件的生命周期</span><span class="suffix" style="display: none;"></span></h4>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;"><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b9503fda63d34e7683c2a790c81eeca0~tplv-k3u1fbpfcp-watermark.image" alt style="display: block; margin: 0 auto; max-width: 100%; border-radius: 10px; border: 3px solid #F7D3CC;"></figure>
<h4 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 18px;"><span class="prefix" style="display: none;"></span><span class="content">第四步: 安装插件</span><span class="suffix" style="display: none;"></span></h4>
<h5 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 16px;"><span class="prefix" style="display: none;"></span><span class="content">4.1 把 Assets 里面得文件复制到 /data/data/files 目录下</span><span class="suffix" style="display: none;"></span></h5>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://files.mdnice.com/point.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #f8f8f8; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #f8f8f8; border-radius: 5px;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">static</span>&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">void</span>&nbsp;<span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">extractAssets</span><span class="hljs-params" style="line-height: 26px;">(Context&nbsp;context,&nbsp;String&nbsp;sourceName)</span>&nbsp;</span>{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AssetManager&nbsp;am&nbsp;=&nbsp;context.getAssets();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InputStream&nbsp;is&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">null</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FileOutputStream&nbsp;fos&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">null</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">try</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;=&nbsp;am.open(sourceName);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;File&nbsp;extractFile&nbsp;=&nbsp;context.getFileStreamPath(sourceName);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fos&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">new</span>&nbsp;FileOutputStream(extractFile);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">byte</span>[]&nbsp;buffer&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">new</span>&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">byte</span>[<span class="hljs-number" style="color: #008080; line-height: 26px;">1024</span>];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">int</span>&nbsp;count&nbsp;=&nbsp;<span class="hljs-number" style="color: #008080; line-height: 26px;">0</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">while</span>&nbsp;((count&nbsp;=&nbsp;is.read(buffer))&nbsp;&gt;&nbsp;<span class="hljs-number" style="color: #008080; line-height: 26px;">0</span>)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fos.write(buffer,&nbsp;<span class="hljs-number" style="color: #008080; line-height: 26px;">0</span>,&nbsp;count);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fos.flush();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">catch</span>&nbsp;(IOException&nbsp;e)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e.printStackTrace();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">finally</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;closeSilently(is);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;closeSilently(fos);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;}<br></code></pre>
<h5 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 16px;"><span class="prefix" style="display: none;"></span><span class="content">4.2 通过静态代理构建 DexClassLoader</span><span class="suffix" style="display: none;"></span></h5>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;">因为没有上下文环境,上下文环境需要宿主提供给它,一个 DexClassLoader 就包含一个插件,</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://files.mdnice.com/point.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #f8f8f8; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #f8f8f8; border-radius: 5px;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//&nbsp;获取插件目录下的文件</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;File&nbsp;extractFile&nbsp;=&nbsp;mContext.getFileStreamPath(mApkName);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//&nbsp;获取插件包路径</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;dexPath&nbsp;=&nbsp;extractFile.getPath();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//&nbsp;创建Dex输出路径</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;File&nbsp;fileRelease&nbsp;=&nbsp;mContext.getDir(<span class="hljs-string" style="color: #d14; line-height: 26px;">"dex"</span>,&nbsp;Context.MODE_PRIVATE);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//&nbsp;构建&nbsp;DexClassLoader&nbsp;生成目录</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mPluginClassLoader&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">new</span>&nbsp;DexClassLoader(dexPath,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fileRelease.getAbsolutePath(),&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">null</span>,&nbsp;mContext.getClassLoader());<br></code></pre>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;">而 Hook 方式是把 dex 文件合并到宿主的 DexClassLoader 里面,但是绕过 AMS 清单文件注册的 Activity 会 抛 ClassNotFuoundException,所以需要 Hook startActivity 和 handleResumeActivity ,前者实现简单,兼容性好,而且插件是分离的,后者兼容性差,开发方便,但是如果多个插件如果有相同的类,就会出现问题。这里使用第一种方式来处理。</p>
<h5 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 16px;"><span class="prefix" style="display: none;"></span><span class="content">4.3 通过反射 AssertManager 实现资源加载</span><span class="suffix" style="display: none;"></span></h5>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://files.mdnice.com/point.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #f8f8f8; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #f8f8f8; border-radius: 5px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">try</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AssetManager&nbsp;assetManager&nbsp;=&nbsp;AssetManager<span class="hljs-class" style="line-height: 26px;">.<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">class</span>.<span class="hljs-title" style="color: #458; font-weight: bold; line-height: 26px;">newInstance</span>()</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Method&nbsp;method&nbsp;=&nbsp;AssetManager<span class="hljs-class" style="line-height: 26px;">.<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">class</span>.<span class="hljs-title" style="color: #458; font-weight: bold; line-height: 26px;">getMethod</span>("<span class="hljs-title" style="color: #458; font-weight: bold; line-height: 26px;">addAssetPath</span>",&nbsp;<span class="hljs-title" style="color: #458; font-weight: bold; line-height: 26px;">String</span>.<span class="hljs-title" style="color: #458; font-weight: bold; line-height: 26px;">class</span>)</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;method.invoke(assetManager,&nbsp;dexPath);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mPluginResources&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">new</span>&nbsp;Resources(assetManager,&nbsp;mContext.getResources().getDisplayMetrics(),<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mContext.getResources().getConfiguration());<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">catch</span>&nbsp;(Exception&nbsp;e)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Toast.makeText(mContext,&nbsp;<span class="hljs-string" style="color: #d14; line-height: 26px;">"加载&nbsp;Plugin&nbsp;失败"</span>,&nbsp;Toast.LENGTH_SHORT).show();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br></code></pre>
<h4 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 18px;"><span class="prefix" style="display: none;"></span><span class="content">第五步: 解析插件</span><span class="suffix" style="display: none;"></span></h4>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;">静态代理实现方式很简单,不需要熟悉 Activity 启动流程什么的,直接面向接口编程,首先需要在宿主 App 加载插件狗仔 DExClassCloder 和 Resource 对象,有了 DexClassLoader,就可以加载插件里面的类 Resource 是通过反射 AssertManager 的 addAssertPath 创建一个 AssertManager,再构造 Resource 对象</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://files.mdnice.com/point.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #f8f8f8; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #f8f8f8; border-radius: 5px;">&nbsp;<span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">void</span>&nbsp;<span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">parserApkAction</span><span class="hljs-params" style="line-height: 26px;">()</span>&nbsp;</span>{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">try</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Class&nbsp;packageParserClass&nbsp;=&nbsp;Class.forName(<span class="hljs-string" style="color: #d14; line-height: 26px;">"android.content.pm.PackageParser"</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Object&nbsp;packageParser&nbsp;=&nbsp;packageParserClass.newInstance();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Method&nbsp;method&nbsp;=&nbsp;packageParserClass.getMethod(<span class="hljs-string" style="color: #d14; line-height: 26px;">"parsePackage"</span>,&nbsp;File<span class="hljs-class" style="line-height: 26px;">.<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">class</span>,&nbsp;<span class="hljs-title" style="color: #458; font-weight: bold; line-height: 26px;">int</span>.<span class="hljs-title" style="color: #458; font-weight: bold; line-height: 26px;">class</span>)</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;File&nbsp;extractFile&nbsp;=&nbsp;mContext.getFileStreamPath(mApkName);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Object&nbsp;packageObject&nbsp;=&nbsp;method.invoke(packageParser,&nbsp;extractFile,&nbsp;PackageManager.GET_RECEIVERS);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Field&nbsp;receiversFields&nbsp;=&nbsp;packageObject.getClass().getDeclaredField(<span class="hljs-string" style="color: #d14; line-height: 26px;">"receivers"</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArrayList&nbsp;arrayList&nbsp;=&nbsp;(ArrayList)&nbsp;receiversFields.get(packageObject);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Class&nbsp;packageUserStateClass&nbsp;=&nbsp;Class.forName(<span class="hljs-string" style="color: #d14; line-height: 26px;">"android.content.pm.PackageUserState"</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Class&nbsp;userHandleClass&nbsp;=&nbsp;Class.forName(<span class="hljs-string" style="color: #d14; line-height: 26px;">"android.os.UserHandle"</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">int</span>&nbsp;userId&nbsp;=&nbsp;(<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">int</span>)&nbsp;userHandleClass.getMethod(<span class="hljs-string" style="color: #d14; line-height: 26px;">"getCallingUserId"</span>).invoke(<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">null</span>);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">for</span>&nbsp;(Object&nbsp;activity&nbsp;:&nbsp;arrayList)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Class&nbsp;component&nbsp;=&nbsp;Class.forName(<span class="hljs-string" style="color: #d14; line-height: 26px;">"android.content.pm.PackageParser$Component"</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Field&nbsp;intents&nbsp;=&nbsp;component.getDeclaredField(<span class="hljs-string" style="color: #d14; line-height: 26px;">"intents"</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//&nbsp;1.获取&nbsp;Intent-Filter</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArrayList&lt;IntentFilter&gt;&nbsp;intentFilterList&nbsp;=&nbsp;(ArrayList&lt;IntentFilter&gt;)&nbsp;intents.get(activity);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//&nbsp;2.需要获取到广播的全类名，通过&nbsp;ActivityInfo&nbsp;获取</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//&nbsp;ActivityInfo&nbsp;generateActivityInfo(Activity&nbsp;a,&nbsp;int&nbsp;flags,&nbsp;PackageUserState&nbsp;state,&nbsp;int&nbsp;userId)</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Method&nbsp;generateActivityInfoMethod&nbsp;=&nbsp;packageParserClass<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.getMethod(<span class="hljs-string" style="color: #d14; line-height: 26px;">"generateActivityInfo"</span>,&nbsp;activity.getClass(),&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">int</span><span class="hljs-class" style="line-height: 26px;">.<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">class</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-title" style="color: #458; font-weight: bold; line-height: 26px;">packageUserStateClass</span>,&nbsp;<span class="hljs-title" style="color: #458; font-weight: bold; line-height: 26px;">int</span>.<span class="hljs-title" style="color: #458; font-weight: bold; line-height: 26px;">class</span>)</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ActivityInfo&nbsp;activityInfo&nbsp;=&nbsp;(ActivityInfo)&nbsp;generateActivityInfoMethod.invoke(<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">null</span>,&nbsp;activity,&nbsp;<span class="hljs-number" style="color: #008080; line-height: 26px;">0</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;packageUserStateClass.newInstance(),&nbsp;userId);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Class&nbsp;broadcastReceiverClass&nbsp;=&nbsp;getClassLoader().loadClass(activityInfo.name);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BroadcastReceiver&nbsp;broadcastReceiver&nbsp;=&nbsp;(BroadcastReceiver)&nbsp;broadcastReceiverClass.newInstance();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">for</span>&nbsp;(IntentFilter&nbsp;intentFilter&nbsp;:&nbsp;intentFilterList)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mContext.registerReceiver(broadcastReceiver,&nbsp;intentFilter);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">catch</span>&nbsp;(Exception&nbsp;e)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e.printStackTrace();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br></code></pre>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;">有了 AssertManager 对象就可以访问资源文件了,但是插件是没有 Context 上下文环境的,这个上下文环境需要宿主提供给他,具体做法是通过 PackManager 获取插件入口的 Activity 注注入宿主 Context,这就完成了宿主 App 跳转插件 App 的步骤。但是插件 App 是没有上下文环境的,所以插件 App 里面是不能直接 startActivity,需要拿到宿主 Context startActivity</p>
<h4 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 18px;"><span class="prefix" style="display: none;"></span><span class="content">第六步,代理 Activity: 在 lifecycle_mananager 构建 ActivityInterface 负责管理插件 Activity 生命周期</span><span class="suffix" style="display: none;"></span></h4>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://files.mdnice.com/point.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #f8f8f8; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #f8f8f8; border-radius: 5px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">public</span>&nbsp;<span class="hljs-class" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">interface</span>&nbsp;<span class="hljs-title" style="color: #458; font-weight: bold; line-height: 26px;">ActivityInterface</span>&nbsp;</span>{<br><br><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//&nbsp;插入Activity上下文</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">void</span>&nbsp;<span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">insertAppContext</span><span class="hljs-params" style="line-height: 26px;">(Activity&nbsp;hostActivity)</span></span>;<br><br><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//&nbsp;Activity各个生命周期方法</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">void</span>&nbsp;<span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">onCreate</span><span class="hljs-params" style="line-height: 26px;">(Bundle&nbsp;savedInstanceState)</span></span>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">void</span>&nbsp;<span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">onStart</span><span class="hljs-params" style="line-height: 26px;">()</span></span>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">void</span>&nbsp;<span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">onResume</span><span class="hljs-params" style="line-height: 26px;">()</span></span>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">void</span>&nbsp;<span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">onPause</span><span class="hljs-params" style="line-height: 26px;">()</span></span>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">void</span>&nbsp;<span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">onStop</span><span class="hljs-params" style="line-height: 26px;">()</span></span>;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">void</span>&nbsp;<span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">onDestroy</span><span class="hljs-params" style="line-height: 26px;">()</span></span>;<br>}<br></code></pre>
<h4 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 18px;"><span class="prefix" style="display: none;"></span><span class="content">第七步,代理 Activity: 在 plugin_package 构建 BaseActivity 实现 ActivityInterface</span><span class="suffix" style="display: none;"></span></h4>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;">在 BaseActivity 提供 startActivity,丢给宿主 Activity 去启动</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://files.mdnice.com/point.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #f8f8f8; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #f8f8f8; border-radius: 5px;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">void</span>&nbsp;<span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">startActivity</span><span class="hljs-params" style="line-height: 26px;">(Intent&nbsp;intent)</span>&nbsp;</span>{<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Intent&nbsp;newIntent&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">new</span>&nbsp;Intent();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;newIntent.putExtra(<span class="hljs-string" style="color: #d14; line-height: 26px;">"ext_class_name"</span>,&nbsp;intent.getComponent().getClassName());<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mHostActivity.startActivity(newIntent);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br></code></pre>
<h4 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 18px;"><span class="prefix" style="display: none;"></span><span class="content">第八步,代理 Activity: 在 plugin_package 构建 Activity 插件</span><span class="suffix" style="display: none;"></span></h4>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://files.mdnice.com/point.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #f8f8f8; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #f8f8f8; border-radius: 5px;"><br><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">public</span>&nbsp;<span class="hljs-class" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">class</span>&nbsp;<span class="hljs-title" style="color: #458; font-weight: bold; line-height: 26px;">PluginActivity</span>&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">extends</span>&nbsp;<span class="hljs-title" style="color: #458; font-weight: bold; line-height: 26px;">BaseActivity</span>&nbsp;</span>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-meta" style="color: #999; font-weight: bold; line-height: 26px;">@Override</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">void</span>&nbsp;<span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">onCreate</span><span class="hljs-params" style="line-height: 26px;">(Bundle&nbsp;savedInstanceState)</span>&nbsp;</span>{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">super</span>.onCreate(savedInstanceState);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setContentView(R.layout.activity_main);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;findViewById(R.id.btn_start).setOnClickListener(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v&nbsp;-&gt;&nbsp;startActivity(<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">new</span>&nbsp;Intent(mHostActivity,&nbsp;TestActivity<span class="hljs-class" style="line-height: 26px;">.<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">class</span>))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</span>;<br>&nbsp;}<br>}<br><br><span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//&nbsp;测试插件Activity</span><br><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">public</span>&nbsp;<span class="hljs-class" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">class</span>&nbsp;<span class="hljs-title" style="color: #458; font-weight: bold; line-height: 26px;">TestActivity</span>&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">extends</span>&nbsp;<span class="hljs-title" style="color: #458; font-weight: bold; line-height: 26px;">BaseActivity</span>&nbsp;</span>{<br><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-meta" style="color: #999; font-weight: bold; line-height: 26px;">@Override</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">void</span>&nbsp;<span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">onCreate</span><span class="hljs-params" style="line-height: 26px;">(Bundle&nbsp;savedInstanceState)</span>&nbsp;</span>{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">super</span>.onCreate(savedInstanceState);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setContentView(R.layout.activity_test);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>}<br></code></pre>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;"><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/de39e65ee1094c29b478a9f12f2b89af~tplv-k3u1fbpfcp-watermark.image" alt style="display: block; margin: 0 auto; max-width: 100%; border-radius: 10px; border: 3px solid #F7D3CC;"></figure>
<h4 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 18px;"><span class="prefix" style="display: none;"></span><span class="content">第九步: 启动插件的入口 Activity</span><span class="suffix" style="display: none;"></span></h4>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;">这一步主要做的就是给插件注册一个宿主的 Context</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://files.mdnice.com/point.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #f8f8f8; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #f8f8f8; border-radius: 5px;">&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//&nbsp;PorxyActivity</span><br><span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">protected</span>&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">void</span>&nbsp;<span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">onCreate</span><span class="hljs-params" style="line-height: 26px;">(@Nullable&nbsp;Bundle&nbsp;savedInstanceState)</span>&nbsp;</span>{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">super</span>.onCreate(savedInstanceState);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//&nbsp;获取到真正要启动的插件&nbsp;Activity，然后执行&nbsp;onCreate&nbsp;方法</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;className&nbsp;=&nbsp;getIntent().getStringExtra(EXT_CLASS_NAME);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">try</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Class&nbsp;clazz&nbsp;=&nbsp;getClassLoader().loadClass(className);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ActivityInterface&nbsp;activityInterface&nbsp;=&nbsp;(ActivityInterface)&nbsp;clazz.newInstance();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-comment" style="color: #998; font-style: italic; line-height: 26px;">//&nbsp;注册宿主的&nbsp;Context</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;activityInterface.insertAppContext(<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">this</span>);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;activityInterface.onCreate(savedInstanceState);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">catch</span>&nbsp;(Exception&nbsp;e)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e.printStackTrace();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-meta" style="color: #999; font-weight: bold; line-height: 26px;">@Override</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">void</span>&nbsp;<span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">startActivity</span><span class="hljs-params" style="line-height: 26px;">(Intent&nbsp;intent)</span>&nbsp;</span>{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;className&nbsp;=&nbsp;intent.getStringExtra(EXT_CLASS_NAME);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Intent&nbsp;proxyIntent&nbsp;=&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">new</span>&nbsp;Intent(<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">this</span>,&nbsp;ProxyActivity<span class="hljs-class" style="line-height: 26px;">.<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">class</span>)</span>;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proxyIntent.putExtra(EXT_CLASS_NAME,&nbsp;className);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">super</span>.startActivity(proxyIntent);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br></code></pre>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;">这样其实就已经完成了 PluginActivity 的启动了，但是需要注意的是，在插件的 Activity 里面，我们不能再使用 this 了，因为插件并没有上下文环境，所以一些调用 Context 的方法都需要使用宿主的 Context 去执行，比如：</p>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;">在 BaseActivity 提供 findViewById,可以查找布局 Id 文件</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://files.mdnice.com/point.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #f8f8f8; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #f8f8f8; border-radius: 5px;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">public</span>&nbsp;View&nbsp;<span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">findViewById</span><span class="hljs-params" style="line-height: 26px;">(<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">int</span>&nbsp;layoutId)</span>&nbsp;</span>{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">return</span>&nbsp;mHostActivity.findViewById(layoutId);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br></code></pre>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;">在 BaseActivity 提供 setContentView,方便渲染 UI 布局</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://files.mdnice.com/point.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #f8f8f8; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: #333; display: -webkit-box; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #f8f8f8; border-radius: 5px;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">public</span>&nbsp;<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">void</span>&nbsp;<span class="hljs-title" style="color: #900; font-weight: bold; line-height: 26px;">setContentView</span><span class="hljs-params" style="line-height: 26px;">(<span class="hljs-keyword" style="color: #333; font-weight: bold; line-height: 26px;">int</span>&nbsp;resId)</span>&nbsp;</span>{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mHostActivity.setContentView(resId);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br></code></pre>
<h3 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 20px;"><span class="prefix" style="display: none;"></span><span class="content">插件化原理介绍</span><span class="suffix" style="display: none;"></span></h3>
<ol data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: decimal;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">使用 DexClassLoader 加载插件的 Apk</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">通过代理的 Activity 去执行插件中的 Activity，加载对应的生命周期</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">通过反射调用 AssetManager 的 addAssetPath 来加载插件中的资源</section></li></ol>
<h3 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 20px;"><span class="prefix" style="display: none;"></span><span class="content">插件化遇到的问题</span><span class="suffix" style="display: none;"></span></h3>
<h4 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 18px;"><span class="prefix" style="display: none;"></span><span class="content">找到的 Activity 不在插件包里面而在 app 目录下</span><span class="suffix" style="display: none;"></span></h4>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;">我们真正打开的确实一个在插件包中定义的 Activity，这个 Activity 需要的信息在插件包中的，而不是宿主的。</p>
<h5 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 16px;"><span class="prefix" style="display: none;"></span><span class="content">解决方案</span><span class="suffix" style="display: none;"></span></h5>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;">插件 Activity 也同时重写了 attachBaseContext 方法。在这一步， 用插件的 classloader 和 Resources 实例创建一个自己的上下文，并用它替换 base context 传递给父类保存。如此一来，业务调用 getClassLoader()或者 getResources()时，取得的就都是插件的信息了。</p>
<h4 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 18px;"><span class="prefix" style="display: none;"></span><span class="content">资源 Id 类型不匹配 找不到</span><span class="suffix" style="display: none;"></span></h4>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;">你需要通过一个资源 ID 获取一个 drawable 的时候，取得的是 color 或者其他资源</p>
<h5 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 16px;"><span class="prefix" style="display: none;"></span><span class="content">解决方案</span><span class="suffix" style="display: none;"></span></h5>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;">主要发生在 8.0 以下版本。经过调查发现在 8.0 以下的插件包中，ContextThemeWrapper.mResources 是宿主的 Resource，而非插件的 Resource。从而导致同一个 ID 找到的资源不对应。</p>
<h4 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 18px;"><span class="prefix" style="display: none;"></span><span class="content">插件包 leakcanary 引发的崩溃</span><span class="suffix" style="display: none;"></span></h4>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;">leakcanary 会使用栈顶的 activity 的 Resource 去加载它要显示的一张图片，但这个资源有可能不在当前插件中。</p>
<h5 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; color: black; font-size: 16px;"><span class="prefix" style="display: none;"></span><span class="content">解决方案</span><span class="suffix" style="display: none;"></span></h5>
<p data-tool="mdnice编辑器" style="padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; font-size: 17px; word-spacing: 3px; letter-spacing: 1px;">宿主和所有插件都依赖 leakcanary 即可。</p>
</section>

### 总结

本文主要是根据我自身实际投产的  插件组件化 实践，分享一些动态加载 SDK插件 时需要考虑的问题。内容主要包括插件化方案的共同问题、插件包 leakcanary 引发的崩溃、资源 Id 类型不匹配  、宿主Activity 找不到问题，千言万语汇成一句话：

> 插件有风险，投资须谨慎！


### 参考链接

[VirtualApk 插件化](https://github.com/Omooo/VirtualApplication)
